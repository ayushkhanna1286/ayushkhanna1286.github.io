<!DOCTYPE html>
<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
<link href='https://fonts.googleapis.com/css?family=Lato:300,900' rel='stylesheet' type='text/css'>
<style>
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 180px;
        height: 125px;
        padding: 2px;
        font: 14px sans-serif;
        background: lightgrey;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }

    svg {
        background-color: GhostWhite;
        font-family: 'Lato';
    }

    .annotation-group, text.title {
        font-size: .9em;
    }
    :root {
        --annotation-color: #E8336D;
    }
	line {
       stroke:#eae4e4;
     }
	.annotation path {
        stroke: var(--annotation-color);
        fill: rgba(0,0,0,0);
      }
	.annotation path.connector-arrow{
        fill: var(--annotation-color);
      }

      .annotation text {
        fill: var(--annotation-color);
      }

      .annotation-title {
        font-weight: bold;
      }

       circle.handle {
        stroke-dasharray: 5;
        stroke: var(--annotation-color);
        fill: rgba(255, 255, 255, .5);
        cursor: move;

        stroke-opacity: .4;
      }

      circle.handle.highlight {
        stroke-opacity: 1;
      }
        
       .annotation-note-bg {
          fill: rgba(255, 255, 255, 0);
        }
    text.title {
        font-size: .10em;
    }
	
	/* circle {fill: lightblue; stroke: black;} */
	circle {stroke: black;}
</style>
<body onload='init();'>
<h2> Cars Mileage Comparison in City vs. Highway in 2017 for different Fuel Types </h2><br/>
<!-- Initialize a select button -->
<div><select id="selectxdropdown"></select></div>
<svg width=1700 height=700>
</svg>
<script>
	 let FuelType = []
	 let selected_regions = []
	 let tickval = []
	 let years = ["<-", 2010, 2011, 2012, 2013, 2014, 2015,2016,2017,2018,2019,2020, "->"]
     let select_year = 2010
	 var margin=50
     var width=1600
     var height=600
	 let svg_dim = 600
	 var xlabel = ""
async function init() {
     // Read the Data	   
     data = await d3.csv("https://ayushkhanna1286.github.io/WDI_Tableau_Data.csv");
	 const type = d3.annotationXYThreshold
	 //d3.annotationCalloutCircle
	 //const type = d3.annotationLabel
	 const electric_annotations = [{
           note: {
                 label: "Electricity Fuel Type Vehicles",
                 bgPadding: 5,
                 title: "Electricity"
           },
           //can use x, y directly instead of data
           dx:140,//140,
           dy:100, // To increase Annotation line
		   x:1120,
		   y:250,
		   subject: {
                    y1: 200,
                    y2: 350,
            },
			className:"annotation_electric"
     }]

	 const gasoline_annotations = [{
           note: {
                 label: "Gasoline Fuel Type Vehicles",
                 bgPadding: 5,
                 title: "Gasoline"
           },
           //can use x, y directly instead of data
           dx:-40,// To increase Annotation line in X Direction
           dy:-40, // To increase Annotation line in Y Direction
		   x:490, // X Location of Annotation
		   y:400, // Y Location of Annotation
		   subject: {
                    x1: 80,
                    x2: 550,
            },
			className:"annotation_gasoline"
     }]
	 
     const makeAnnotations_elect = d3.annotation()//.editMode(true)
                             .notePadding(15)
                             .type(type)
                             .annotations(electric_annotations)

     const makeAnnotations_gaso = d3.annotation()//.editMode(true)
                             .notePadding(15)
                             .type(type)
                             .annotations(gasoline_annotations)

	 clear_all = []
	 // List of groups (here I have one group per column)
     var XAxis_Group = ["BirthRate", "HealthSpend", "LifeExp"]
	 
     d3.selectAll("g").data(clear_all).exit().remove()
     
	 Region = d3.map(data, function(d){return d.Region;}).keys()
	 //console.log(Region)
	 selected_region = [...Region]
	 console.log(selected_region)
     
     x = d3.scaleLinear().domain([0,60]).range([0,width])
	 //console.log("selectedOption:"+selectedOption)
	 //x,y,c_col,csize = define_axis_values(selectedOption)
	 //console.log(x)
     y = d3.scaleLinear().domain([0,20]).range([height,0])
     c_col = d3.scaleOrdinal().domain(Region).range([ "#440154ff", "#21908dff", "darkorange","red","green","pink","brown"])
	 csize = d3.scaleLog().domain([10,50]).range([0,670])

	 // Add Year Range
	 d3.select("svg")
                .selectAll("g")
                .data(years)
                .enter()
                .append("g")
                .attr("transform", function(d, i) { return "translate(" + (100+i*65) + ",30)"; })
                .append("text")
                .text(function(d,i){return(years[i])})
                .style('font-weight', 600)
	// When the button is changed, run the updateChart function
    d3.select("#selectxdropdown").on("change", function(d) {
        // recover the option that has been chosen
        var selectedOption = d3.select(this).property("value")
        // run the updateChart function with this selected option
        update_axis(selectedOption)
    })
     //Add years as rectangles and onclick logic to change chart
     d3.select("svg")
       .selectAll("g")
       .each(function(d, i)
       {
          d3.select(this).append("rect")
            .attr("id", "year"+String(d))
            .attr('x', -5)
            .attr('y', -15)
            .attr('opacity', .2)
            .attr('width', 55)
            .attr('height', 20)
            .attr('stroke', 'black')
            .attr('fill', function(d,i) {
                    if(d=="<-" || d=="->") return("yellow")
                    if(Number(d)===2010) return('blue');
                          else return ('brown');
                 })
            .on('click', function(d,i)
            {
               d3.selectAll("rect").attr("fill", function(d) {
                    if(d=="->" || d=="<-") return ("yellow");
                    else return ("brown")
               })

               d3.select(this).attr("fill", function(d){
                    if(d=="->" || d=="<-") return ("yellow");
                    else return ("blue")
               })
               if(d=="->"){
                    let year_index = years.indexOf(select_year)
                    if(year_index < (years.length - 2)) select_year = years[year_index+1]
               }
               else if(d=="<-"){
                    let year_index = years.indexOf(select_year)
                    if(year_index > 1) select_year = years[year_index-1]
               }
               else select_year = Number(d);
               let id_selected = "#year" + String(select_year)
               //console.log("select_year:"+select_year)
			   d3.select(id_selected).attr("fill", "lightblue")
			   var selectedOption = d3.select('#selectxdropdown').property("value")
			   update_axis(selectedOption)
			   //plot_points("Avg_ Birth Rate (Per 1000) (SUM)")
               //show_year_annotation(select_year)
            });
       })

     d3.select('svg')
       .append('g')
	   .attr("id", "chart")
       .attr("transform","translate("+ margin + "," + margin + ")")
	 
	 	 
 	// add the options to the button
    d3.select("#selectxdropdown")
      .selectAll('myOptions')
      .data(XAxis_Group)
      .enter()
      .append('option')
      .text(function (d) { return d; }) // text showed in the menu
      .attr("value", function (d) { return d; }) // corresponding value returned by the button

	 let chart = d3.select("#chart")
	
	 //Filter dataset to be just the year selected
     let select_year_data = data.filter(function(e){return (e.Year==select_year)})
	 //Add a Tooltip DIV Tag
	 var div = d3.select("body").append("div")
               .attr("class", "tooltip")
               .style("opacity", 0);

	 chart.selectAll("g")
	   .data(select_year_data)
	   .enter()
	   .append('circle')
	   .attr("transform", function(d, i) {
                    let birth_rate = x(Number(d["Avg_ Birth Rate (Per 1000) (SUM)"]))
                    let death_rate = y(Number(d["Avg_ Death Rate (Per 1000) (SUM)"]))
                    return "translate(" + birth_rate + "," + death_rate + ")"; })
	   .attr('r', function(d,i) {return csize(d["Avg_ Total Population (SUM)"])/380})
       .attr("id", function(d){return d["Country Code (WDICountry_csv)"]}) 
       .style("fill", function(d){ return c_col(d.Region)})
       .attr("opacity",0.8)	   
	   
	   // Add Tooltip to show the Fuel type on mouse over
       .on("mouseover", function(d) {      
                        div.transition()     
                           .duration(200)      
                           .style("opacity", .9);       
						div.html(function(){return "<b>" + d["Country Name"] + "</b>" + "<br/> Total Pop.:"+ d["Avg_ Total Population (SUM)"]
						                    + "<br/> Health Spend/Capita ($):" + d["Avg_ Health Spend / Capita ($) (SUM)"] 
                                            + "<br/> Avg. Life Expectancy:" + d["Avg_ Life Expectancy (SUM)"]
											+ "<br/> Avg. Birth Rate:" +d["Avg_ Birth Rate (Per 1000) (SUM)"]
											+ "<br/> Avg. Death Rate:" +d["Avg_ Death Rate (Per 1000) (SUM)"]
                            })  
                           .style("left", (d3.event.pageX) + "px")     
                           .style("top", (d3.event.pageY - 28) + "px");    
                     })                  
       .on("mouseout", function(d) {       
                     div.transition()        
                     .duration(500)      
                     .style("opacity", 0);   
                     })
       // Set Chart Legends
       chart.selectAll("foreignObject")
                .data(Region).enter()
                .append("foreignObject")
                .attr('x', 1350)
                .attr('y',  function(d,i){ return 20-10 + i*20})
                .attr('width', 290)
                .attr('height', 20)
                .append("xhtml:tree")
                .html(function(d, i){
                    let s = "<label style='color:" + c_col(d)
                        + "'><input type='checkbox' checked=true id='" + d
                        + "' onclick=RegionSelected(this)>" + d + "</label>"
                    return(s);
                })
                .style("fill", function(d){ return c_col(d)})
				
	//Show labels for Circles
    let counter = 0;
    chart.selectAll("g")
         .each(function(d, i)
         {
            d3.select(this)
              .append("text").text(function (d, i){
              let country = d["Country Name"]
              counter++;
              return (country)
              })
              .attr("font-size", 10)
              .attr("x", -9)
              .attr("y", 12 + Math.round(Math.random())*-20)
         })

     // Plot Y Axis
	 tickval = define_tick_values("BirthRate")
     d3.select('svg').append('g')
       .attr("transform","translate("+ margin + "," + margin + ")")
       .call(d3.axisLeft(y).tickValues(tickval).tickFormat(d3.format("~d")))
     
     // Plot X Axis
     d3.select('svg').append('g')
	   .attr("class", "xaxis")
       .attr("transform", "translate(" + margin + ",650)")
       .call(d3.axisBottom(x).tickValues(tickval).tickFormat(d3.format("~d")))
	   
     // Plot Annotations
     d3.select('svg').append('g')
	   .attr("class", "annotation-group")
       .call(makeAnnotations_elect)
     d3.select('svg').append('g')
	   .attr("class", "annotation-group")
       .call(makeAnnotations_gaso)
	   
     //	 Plot X and Y Labels
	 var xlabel = d3.select("svg").append("text")
       .attr("class", "x label")
       .attr("text-anchor", "end")
       .attr("x", 1000)
       .attr("y", 1.75*margin+svg_dim+5	)
       .style('fill', 'DarkGreen')
       .style('font-weight', 'bold')
       .text("Avg. Birth Rate (Per 1000)")

     var ylabel = d3.select("svg").append("text")
       .attr("class", "y label")
       .attr("text-anchor", "end")
       .attr("x", -svg_dim/3)
       .attr("y", 10)
       .attr("dy", ".25em")
       .style('fill', 'DarkGreen')
       .style('font-weight', 'bold')
       .attr("transform", "rotate(-90)")
       .text("Avg. Death Rate (Per 1000)");
     }
	 
	 var yeartag = d3.select("svg").append("text")
       .attr("class", "yeartag")
       .attr("text-anchor", "end")
       .attr("x", 1300)
       .attr("y", 100)
       .style('fill', 'DarkGrey')
       .style('font-weight', 'bold')
	   .style('font-size',"50px")
       .text(select_year)
	   .attr("opacity",0.35)

	// A function that update the chart
    function update_axis(selectedGroup) {
	 let chart = d3.select("#chart")
      col = findcol_Name(selectedGroup)
	  plot_points(col,selectedGroup)
     
    }
	
	function findcol_Name(selectedGroup) {
	if (selectedGroup == "BirthRate") {
	        col = "Avg_ Birth Rate (Per 1000) (SUM)"
		}
	  else if (selectedGroup == "HealthSpend" ) {
	        col = "Avg_ Health Spend / Capita ($) (SUM)"
	   }
	  else if (selectedGroup == "LifeExp" ) {
	        col = "Avg_ Life Expectancy (SUM)"
	  }
	 return col
	}
	
	// ##################################################################################
    function define_tick_values(selectedGroup) {
		if (selectedGroup == "BirthRate") { tickvalues = [0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,90]}
		else if (selectedGroup == "HealthSpend") { tickvalues = [15,35,75,125,230,400,1000,2000,3000,4000,6000,7000,9000]}
		else if (selectedGroup == "LifeExp") { tickvalues = [40,45,50,55,60,65,70,75,80,85,90]}
	return tickvalues
	}
	// #################################################################################
	function RegionSelected(object){
        let checked = object.checked
        let clicked_region = object.id
        console.log("Checked Value:"+checked);
		console.log("Clicked Value:"+clicked_region);
        if (!checked){
            selected_region.splice(selected_region.indexOf(clicked_region),1);
            if(clicked_region=="Latin America & Caribbean") {
			          d3.select(".Latin America \\& Caribbean").attr("opacity", 0);
					  d3.select(".annotation_gasoline").attr("opacity", 0.25);
					 }
            if(clicked_region=="East Asia & Pacific") {
					  d3.select(".East Asia \\& Pacific").attr("opacity", 0);
					  //d3.select(".annotation_diesel").attr("opacity", 0.25);
					 }
            if(clicked_region=="Sub-Saharan Africa") {
			          d3.select(".Sub-Saharan Africa").attr("opacity", 0);
					  d3.select(".annotation_electric").attr("opacity", 0.25);
					  }
            if(clicked_region=="South Asia") {
					  d3.select(".South Asia").attr("opacity", 0);
					  //d3.select(".annotation_diesel").attr("opacity", 0.25);
					 }
		    if(clicked_region=="Europe & Central Asia") {
					  d3.select(".Europe \\& Central Asia").attr("opacity", 0);
					  //d3.select(".annotation_diesel").attr("opacity", 0.25);
					 }
			if(clicked_region=="North America") {
					  d3.select(".North America").attr("opacity", 0);
					  //d3.select(".annotation_diesel").attr("opacity", 0.25);
					 }
		    if(clicked_region=="Middle East & North Africa") {
					  d3.select(".Middle East \\& North Africa").attr("opacity", 0);
					  //d3.select(".annotation_diesel").attr("opacity", 0.25);
					 }
        }
        else{
            selected_region.push(clicked_region);
            if(clicked_region=="Latin America & Caribbean") {
			          d3.select(".Latin America \\& Caribbean").attr("opacity", 1);
					  d3.select(".annotation_gasoline").attr("opacity", 1);
					 }
            if(clicked_region=="East Asia & Pacific") d3.select(".East Asia \\& Pacific").attr("opacity", 1);
            if(clicked_region=="Sub-Saharan Africa") {
			          d3.select(".Sub-Saharan Africa").attr("opacity", 1);
					  d3.select(".annotation_electric").attr("opacity", 1);
					}
			if(clicked_region=="South Asia") d3.select(".South Asia").attr("opacity", 1);
			if(clicked_region=="Europe \\& Central Asia") d3.select(".Europe & Central Asia").attr("opacity", 1);
			if(clicked_region=="North America") d3.select(".North America").attr("opacity", 1);
			if(clicked_region=="Middle East \\& North Africa") d3.select(".Middle East & North Africa").attr("opacity", 1);
        }
		var selectedOption = d3.select('#selectxdropdown').property("value")
		console.log("selectedOption:"+selectedOption)
        update_axis(selectedOption)
        //plot_points("Avg_ Birth Rate (Per 1000) (SUM)");
    }
    function plot_points(X_Col,selectedGrp)
	{
        //d3.select("#chart").selectAll("circle").data(clear_all).exit().remove()
        let cur_x = 0
        let cur_y = 0
        let max_val = 0
		let min_val = 1000 
		console.log("year:"+select_year)
		//console.log("selectedGrp:"+selectedGrp)
		let select_year_data = data.filter(function(e){return (e.Year==select_year && e["Avg_ Death Rate (Per 1000) (SUM)"] != 0)})
		if (selectedGrp == "BirthRate") {select_year_data = data.filter(function(e){return (e.Year==select_year && e["Avg_ Death Rate (Per 1000) (SUM)"] != 0 && !isNaN(e["Avg_ Death Rate (Per 1000) (SUM)"]))})}
		else if (selectedGrp == "HealthSpend") {select_year_data = data.filter(function(e){return (e.Year==select_year && e["Avg_ Health Spend / Capita ($) (SUM)"] != 0 && e["Avg_ Death Rate (Per 1000) (SUM)"] != 0)})}
		else if (selectedGrp == "LifeExp") {select_year_data = data.filter(function(e){return (e.Year==select_year && e["Avg_ Life Expectancy (SUM)"] != 0 && e["Avg_ Death Rate (Per 1000) (SUM)"] != 0 && !isNaN(e["Avg_ Life Expectancy (SUM)"]))})}
		
        //let select_year_data = data.filter(({ Region, Year}) => selected_region.includes(Region) && Year==select_year )
		//data.filter(function(d){return (d.Year==select_year)})
        console.log("select_year_data.length:"+select_year_data.length)
        //let select_year_region_data = data.filter(({ Region, Year }) => selected_region.includes(Region) && Year==select_year)
        for(i=0; i < select_year_data.length; i++){
            let x_col = Number(select_year_data[i][X_Col])
            let death_rate = Number(select_year_data[i]["Avg_ Death Rate (Per 1000) (SUM)"]);
            let country = select_year_data[i]["Country Code (WDICountry_csv)"]
			let country_name = select_year_data[i]["Country Name"]
            let region = select_year_data[i]["Region"]
			
			max_col_val = Number(select_year_data[i][X_Col]);
			min_col_val = Number(select_year_data[i][X_Col]);

            if(min_col_val < min_val && min_col_val!= 0) min_val = min_col_val;
            if(max_col_val > max_val && max_col_val!= 0) max_val = max_col_val;
			//console.log("min_val:"+min_val)
			//console.log("max_val:"+max_val)
			if (selectedGrp == "BirthRate") {
			                x = d3.scaleLinear().domain([4,max_val+5]).range([0,width])
			}
			else if (selectedGrp == "LifeExp") {
			                x = d3.scaleLinear().domain([42,max_val+5]).range([0,width]);
			}
			else if (selectedGrp == "HealthSpend") {x = d3.scaleLog().domain([10,max_val]).range([0,width])}

            const t = d3.transition()
                .duration(2000).delay(100)
                .ease(d3.easeLinear);

            if(selected_region.indexOf(region)>-1)
			{
                d3.select("#" + country).attr("opacity",0.8);
				
			}
            else {
                d3.select("#" + country).attr("opacity",0.05);
				//d3.select("#" + country ).transition(t).attr("transform", "translate(" + x(x_col) + "," + y(death_rate) + ")")
            } 
            
			d3.select("#" + country ).transition(t).attr("transform", "translate(" + x(x_col) + "," + y(death_rate) + ")")
			
            if (x_col != 0 && selected_region.indexOf(region)>-1) {
                    d3.select("#" + country ).datum(select_year_data[i])
			}
        }
		// Re-Plot X Axis again
        d3.select('svg').selectAll('g.xaxis').transition().duration(1000).call(d3.axisBottom(x).tickFormat(d3.format("~d")))
	    //xlabel.text("Avg. Life Expectancy")
		yeartag.text(select_year)
    }	
</script>
</body>
</html>