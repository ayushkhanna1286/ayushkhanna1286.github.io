<!DOCTYPE html>
<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
<link href='https://fonts.googleapis.com/css?family=Lato:300,900' rel='stylesheet' type='text/css'>
<style>
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 180px;
        height: 125px;
        padding: 2px;
        font: 14px sans-serif;
        background: lightgrey;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f1f1f1;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

    svg {
        background-color: GhostWhite;
        font-family: 'Lato';
    }

    .annotation-group, text.title {
        font-size: .8em;
    }
    :root {
        --annotation-color: #E8336D;
    }
	line {
       stroke:#eae4e4;
     }
	.annotation path {
        stroke: var(--annotation-color);
        fill: rgba(0,0,0,0);
      }
	.annotation path.connector-arrow{
        fill: var(--annotation-color);
      }

      .annotation text {
        fill: var(--annotation-color);
      }

      .annotation-title {
        font-weight: bold;
      }

       circle.handle {
        stroke-dasharray: 5;
        stroke: var(--annotation-color);
        fill: rgba(255, 255, 255, .5);
        cursor: move;

        stroke-opacity: .4;
      }

      circle.handle.highlight {
        stroke-opacity: 1;
      }
        
       .annotation-note-bg {
          fill: rgba(255, 255, 255, 0);
        }
    text.title {
        font-size: .10em;
    }
	
	/* circle {fill: lightblue; stroke: black;} */
	circle {stroke: black;}
</style>
<body onload='init();'>
<h2> World Indicator - Death Rates vs Birth Rates Comparison </h2><br/>
<!-- Initialize a select button -->
<div><select id="selectxdropdown"></select></div>
<svg width=1500 height=700>
</svg>
<svg id="linesvg" width=350 height=700></svg>
<script>
	 let FuelType = []
	 let selected_regions = []
	 let tickval = []
	 let years = ["<<=", 2010, 2011, 2012, 2013, 2014, 2015,2016,2017,2018,2019,2020,"=>>"]
     let select_year = 2010
	 var margin=50
     var width=1400 //1600
     var height=600
	 let svg_dim = 600
	 var xlabel = ""
async function init() {
     // Read the Data	   
     data = await d3.csv("https://ayushkhanna1286.github.io/WDI_Tableau_Data.csv");
	 let select_year_data = data.filter(function(d){return (d.Year==select_year && d["Avg_ Death Rate (Per 1000) (SUM)"] != 0)});
	 
	 const type = d3.annotationXYThreshold
	 const type_sec = d3.annotationXYThreshold
	 //d3.annotationCalloutCircle
	 //const type = d3.annotationLabel
	 const high_deathbirth_rate_annotations = [{
           note: {
                 label: "Sub-Saharan Africa Countries have High Birth (>35) and Death Rates (>10) over the Years",
                 bgPadding: 5,
                 title: "High Death and Birth Rate"
           },
           //can use x, y directly instead of data
           dx:100,//
           dy:160, // dx and dy To increase Annotation line
		   x:1250, //1410
		   y:260,
		   subject: {
		            //width: -350,
					//height: 200,
                    y1: 190,
                    y2: 350,
            },
			className:"annotation_high_deathbirth_rate"
     }]

	 const high_deathrate = [{
           note: {
                 label: "Countries Observed a Decrease in Population due to Higher Death Rate than Birth Rate",
                 bgPadding: 1,
                 title: "Decrease in the Population"
           },
           //can use x, y directly instead of data
           dx:40,// To increase Annotation line in X Direction
           dy:-20, // To increase Annotation line in Y Direction
		   x:320, // X Location of Annotation
		   y:185, // Y Location of Annotation
		   subject: {
                    x1: 100,
                    x2: 340,
            },
			className:"annotation_high_deathrate"
     }]
	 
     const makeAnnotations_highdthbrth_rate = d3.annotation().editMode(false)
                             .notePadding(15)
                             .type(type)
                             .annotations(high_deathbirth_rate_annotations)

     const makeAnnotations_highdeath_rate = d3.annotation()//.editMode(true)
                             .notePadding(5)
                             .type(type_sec)
                             .annotations(high_deathrate)

	 clear_circles = []
	 //d3.select('svg').selectAll('chart').data(clear_circles).exit().remove()
	 d3.select('svg').selectAll('chart').html = ""
	 // List of groups (here I have one group per column)
     var XAxis_Group = ["BirthRate", "HealthSpend", "LifeExp"]
	 Region = d3.map(data, function(d){return d.Region;}).keys()
	 selected_region = [...Region]
	 
     x = d3.scaleLinear().domain([4,55]).range([0,width])
     y = d3.scaleLinear().domain([0,20]).range([height,0]) //0,20
     c_col = d3.scaleOrdinal().domain(Region).range([ "#440154ff", "#21908dff", "darkorange","red","green","pink","brown"])
	 csize = d3.scaleLog().domain([10,50]).range([0,670])

     // Select Second SVG element
	 var secondsvg = d3.select('#linesvg')
       .append('g')
	   .attr("id", "section2")
       .attr("transform","translate("+ margin + "," + margin + ")")
	 
	 secondsvg.append("text")
	          .text("The Scatter Chart on Left shows the Death Rate and Birth Rate Comparison Over the Years")
	          .attr("class", "HeadingText1")
              .style('fill', 'DarkGreen')
              .style('font-weight', 'bold')
	          .style('font-size',"15px")
			  .style('opacity',0.9)
			  .attr('x',-35)
			  .attr('y',10)
			  .call(wrap, 320)
	 
	 // Add Year Range
	 d3.select("svg")
       .selectAll("g")
       .data(years)
       .enter()
       .append("g")
       .attr("transform", function(d, i) { return "translate(" + (100+i*65) + ",30)"; })
       .append("text")
       .text(function(d,i){return(years[i])})
       .style('font-weight', 600)
	
     //Add years as rectangles and onclick logic to change chart
     d3.select("svg")
       .selectAll("g")
       .each(function(d, i)
       {
          d3.select(this).append("rect")
            .attr("id", "year"+String(d))
            .attr('x', -5)
            .attr('y', -15)
            .attr('opacity', .2)
            .attr('width', 55)
            .attr('height', 20)
            .attr('stroke', 'black')
            .attr('fill', function(d,i) {
                    if(d=="<<=" || d=="=>>") return("yellow")
                    if(Number(d)===2010) return('blue');
                          else return ('brown');
                 })
            .on('click', function(d,i)
            {
               d3.selectAll("rect").attr("fill", function(d) {
                    if(d=="=>>" || d=="<<=") return ("yellow");
                    else return ("brown")
               })

               d3.select(this).attr("fill", function(d){
                    if(d=="=>>" || d=="<<=") 
					return ("yellow");
                    else return ("blue")
               })
               if(d=="=>>")
			   {
                    let year_index = years.indexOf(select_year)
                    if(year_index < (years.length - 2)) select_year = years[year_index+1]
					console.log("select_year:"+select_year)
               }
               else if(d=="<<="){
                    let year_index = years.indexOf(select_year)
                    if(year_index > 1) select_year = years[year_index-1]
               }
               else select_year = Number(d);
               let id_selected = "#year" + String(select_year)
			   d3.select(id_selected).attr("fill", "lightblue")
			   var selectedOption = d3.select('#selectxdropdown').property("value")
			   update_axis(selectedOption)
            });
       })

     d3.select('svg')
       .append('g')
	   .attr("id", "chart")
       .attr("transform","translate("+ margin + "," + margin + ")")
	 
	 	 
 	// add the options to the button
    d3.select("#selectxdropdown")
      .selectAll('myOptions')
      .data(XAxis_Group)
      .enter()
      .append('option')
      .text(function (d) { return d; }) // text showed in the menu
      .attr("value", function (d) { return d; }) // corresponding value returned by the button

	// When the button is changed, run the updateChart function
    d3.select("#selectxdropdown").on("change", function(d) {
        // recover the option that has been chosen
        var selectedOption = d3.select(this).property("value")
		secondsvg.selectAll("text").remove() // Clear Old Text before replacing it with the new one.
		if (selectedOption == "BirthRate") {
			secondsvg.append("text").text("The Scatter Chart on Left shows the Death Rate (Y-Axis) and Birth Rate (X-Axis) Comparison Over the Years")
	                 .attr("class", "HeadingText1")
                     .style('fill', 'DarkGreen')
                     .style('font-weight', 'bold')
	                 .style('font-size',"15px")
					 .style('opacity',0.9)
					 .attr('x',-35)
					 .attr('y',10)
					 .call(wrap, 320)
		}
	    else if (selectedOption == "LifeExp"){
			secondsvg.append("text").text("The Scatter Chart on Left shows the Death Rate comparison (Y-Axis) with Avg. Life Expectancy (X-Axis) for Countries")
	                 .attr("class", "HeadingText1")
                     .style('fill', 'DarkGreen')
                     .style('font-weight', 'bold')
	                 .style('font-size',"15px")
					 .style('opacity',0.9)
					 .attr('x',-35)
					 .attr('y',10)
					 .call(wrap, 320)
		}
	    else if (selectedOption == "HealthSpend"){
			secondsvg.append("text").text("The Scatter Chart on Left shows the Death Rate comparison (Y-Axis) with Health Spend/Capita (In US$) (X-Axis) for Countries")
	                 .attr("class", "HeadingText1")
                     .style('fill', 'DarkGreen')
                     .style('font-weight', 'bold')
	                 .style('font-size',"15px")
					 .style('opacity',0.9)
					 .attr('x',-35)
					 .attr('y',10)
					 .call(wrap, 320)
		}  
        // run the updateChart function with this selected option
        update_axis(selectedOption)
    })
	let chart = d3.select("#chart")
	var selectedOption = d3.select('#selectxdropdown').property("value")

	//Add a Tooltip DIV Tag
	var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

	chart.selectAll("g")
	    .data(select_year_data)
	    .enter()
	    .append('circle')
	    .attr("transform", function(d, i) {
                    let birth_rate = x(d["Avg_ Birth Rate (Per 1000) (SUM)"])
                    let death_rate = y(d["Avg_ Death Rate (Per 1000) (SUM)"])
                    return "translate(" + birth_rate + "," + death_rate + ")"; })
	    .attr('r', function(d,i) {return csize(d["Avg_ Total Population (SUM)"])/380})
        .attr("id", function(d){return d["Country Code (WDICountry_csv)"]}) 
        .style("fill", function(d){ return c_col(d.Region)})
        .attr("opacity",0.8)

	   // Add Tooltip to show the Details on mouse over
       .on("mouseover", function(d) {      
                        div.transition()     
                           .duration(200)      
                           .style("opacity", .9);       
						div.html(function(){return "<b>" + d["Country Name"] + "</b>" + "<br/> Total Pop.:"+ d["Avg_ Total Population (SUM)"]
						                    + "<br/> Health Spend/Capita ($):" + d["Avg_ Health Spend / Capita ($) (SUM)"] 
                                            + "<br/> Avg. Life Expectancy:" + d["Avg_ Life Expectancy (SUM)"]
											+ "<br/> Avg. Birth Rate:" +d["Avg_ Birth Rate (Per 1000) (SUM)"]
											+ "<br/> Avg. Death Rate:" +d["Avg_ Death Rate (Per 1000) (SUM)"]
                            })  
                           .style("left", (d3.event.pageX) + "px")     
                           .style("top", (d3.event.pageY - 28) + "px");    
                     })                  
       .on("mouseout", function(d) {       
                     div.transition()        
                     .duration(500)      
                     .style("opacity", 0);   
                     })
	    
        // Add Lines
		chart.append('line').data(select_year_data)
             .attr('x1',x(10))
			 .attr('x2',x(10))
             .attr('y1',y(0))
			 .attr('y2',y(20))
			 .style("stroke", "grey")

		chart.append('line').data(select_year_data)
             .attr('x1',x(4))
			 .attr('x2',x(55))
             .attr('y1',y(10))
			 .attr('y2',y(10))
			 .style("stroke", "grey")
       
	   // Add Death Rate and Birth Rate Lines over the Years
	   
            
       // Set Chart Legends
       chart.selectAll("foreignObject")
                .data(Region).enter()
                .append("foreignObject")
                .attr('x', 1200)
                .attr('y',  function(d,i){ return 20-10 + i*20})
                .attr('width', 290)
                .attr('height', 20)
                .append("xhtml:tree")
                .html(function(d, i){
                    let s = "<label style='color:" + c_col(d)
                        + "'><input type='checkbox' checked=true id='" + d
                        + "' onclick=RegionSelected(this)>" + d + "</label>"
                    return(s);
                })
                .style("fill", function(d){ return c_col(d)})
				
     d3.select('svg').append('g')
       .attr("transform","translate("+ margin + "," + margin + ")")
       .call(d3.axisLeft(y).tickFormat(d3.format("~d")))
     
     // Plot X Axis
     d3.select('svg').append('g')
	   .attr("class", "xaxis")
       .attr("transform", "translate(" + margin + ",650)")
       .call(d3.axisBottom(x).tickFormat(d3.format("~d")))
	   
     // Plot Annotations
     d3.select('svg').append('g')
	   .attr("class", "annotation-group")
       .call(makeAnnotations_highdthbrth_rate)
    
	 d3.select('svg').append('g')
	   .attr("class", "annotation-group")
       .call(makeAnnotations_highdeath_rate)
	   
	 //	 Plot X and Y Labels
	 var xlabel = d3.select("svg").append("text")
       .attr("class", "xlabel")
       .attr("text-anchor", "end")
       .attr("x", 900)
       .attr("y", 1.75*margin+svg_dim+5	)
       .style('fill', 'DarkGreen')
       .style('font-weight', 'bold')
       .text("Avg. Birth Rate (Per 1000 People)")

     var ylabel = d3.select("svg").append("text")
       .attr("class", "y label")
       .attr("text-anchor", "end")
       .attr("x", -svg_dim/3)
       .attr("y", 10)
       .attr("dy", ".25em")
       .style('fill', 'DarkGreen')
       .style('font-weight', 'bold')
       .attr("transform", "rotate(-90)")
       .text("Avg. Death Rate (Per 1000 People)");
	   
	 var yeartag = d3.select("svg").append("text")
       .attr("class", "yeartag")
       .attr("text-anchor", "end")
       .attr("x", 1200)
       .attr("y", 100)
       .style('fill', 'DarkGrey')
       .style('font-weight', 'bold')
	   .style('font-size',"60px")
       .text(select_year)
	   .attr("opacity",0.35)
	   
	 // ####################################################################################################################
	 // Section to Details inside Second SVG element
	   
 }
	// A function that update the chart
    function update_axis(selectedGroup) {
	 let chart = d3.select("#chart")
      col = findcol_Name(selectedGroup)
	  plot_points(col,selectedGroup)
     
    }
	
	function wrap(text, width) {
    text.each(function () {
        var text = d3.select(this),
            words = text.text().split(/\s+/).reverse(),
            word,
            line = [],
            lineNumber = 0,
            lineHeight = 1.1, // ems
            x = text.attr("x"),
            y = text.attr("y"),
            dy = 0, //parseFloat(text.attr("dy")),
            tspan = text.text(null)
                        .append("tspan")
                        .attr("x", x)
                        .attr("y", y)
                        .attr("dy", dy + "em");
        while (word = words.pop()) {
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > width) {
                line.pop();
                tspan.text(line.join(" "));
                line = [word];
                tspan = text.append("tspan")
                            .attr("x", x)
                            .attr("y", y)
                            .attr("dy", ++lineNumber * lineHeight + dy + "em")
                            .text(word);
            }
        }
    });
    }

	function findcol_Name(selectedGroup) {
	if (selectedGroup == "BirthRate") {
	        col = "Avg_ Birth Rate (Per 1000) (SUM)"
		}
	  else if (selectedGroup == "HealthSpend" ) {
	        col = "Avg_ Health Spend / Capita ($) (SUM)"
	   }
	  else if (selectedGroup == "LifeExp" ) {
	        col = "Avg_ Life Expectancy (SUM)"
	  }
	 return col
	}
	
	// #########################################################################################################
	function RegionSelected(object){
        let checked = object.checked
        let clicked_region = object.id
        //console.log("Checked Value:"+checked);
		//console.log("Clicked Value:"+clicked_region);
        if (!checked){
            selected_region.splice(selected_region.indexOf(clicked_region),1);
            if(clicked_region=="Latin America & Caribbean") {
			          d3.select(".Latin America \\& Caribbean").attr("opacity", 0);
					  d3.select(".makeAnnotations_highdthbrth_rate").attr("opacity", 0);
					 }
            if(clicked_region=="East Asia & Pacific") {
					  d3.select(".East Asia \\& Pacific").attr("opacity", 0);
					  //d3.select(".annotation_diesel").attr("opacity", 0.25);
					 }
            if(clicked_region=="Sub-Saharan Africa") {
			          d3.select(".Sub-Saharan Africa").attr("opacity", 0);
					  d3.select(".annotation_high_deathbirth_rate").attr("opacity", 0);
					  }
            if(clicked_region=="South Asia") {
					  d3.select(".South Asia").attr("opacity", 0);
					  //d3.select(".annotation_diesel").attr("opacity", 0.25);
					 }
		    if(clicked_region=="Europe & Central Asia") {
					  d3.select(".Europe \\& Central Asia").attr("opacity", 0);
					  //d3.select(".annotation_diesel").attr("opacity", 0.25);
					 }
			if(clicked_region=="North America") {
					  d3.select(".North America").attr("opacity", 0);
					  //d3.select(".annotation_diesel").attr("opacity", 0.25);
					 }
		    if(clicked_region=="Middle East & North Africa") {
					  d3.select(".Middle East \\& North Africa").attr("opacity", 0);
					  //d3.select(".annotation_diesel").attr("opacity", 0.25);
					 }
        }
        else{
            selected_region.push(clicked_region);
            if(clicked_region=="Latin America & Caribbean") {
			          d3.select(".Latin America \\& Caribbean").attr("opacity", 1);
					  d3.select(".annotation_gasoline").attr("opacity", 1);
					 }
            if(clicked_region=="East Asia & Pacific") d3.select(".East Asia \\& Pacific").attr("opacity", 1);
            if(clicked_region=="Sub-Saharan Africa") {
			          d3.select(".Sub-Saharan Africa").attr("opacity", 1);
					  console.log("selectedOption:"+selectedOption)
					  if (selectedOption == "BirthRate") {d3.select(".annotation_high_deathbirth_rate").attr("opacity", 1)}
					  else if (selectedOption == "LifeExp" || selectedOption == "HealthSpend"){d3.select(".annotation_high_deathbirth_rate").attr("opacity", 0)}
					}
			if(clicked_region=="South Asia") d3.select(".South Asia").attr("opacity", 1);
			if(clicked_region=="Europe \\& Central Asia") d3.select(".Europe & Central Asia").attr("opacity", 1);
			if(clicked_region=="North America") d3.select(".North America").attr("opacity", 1);
			if(clicked_region=="Middle East \\& North Africa") d3.select(".Middle East & North Africa").attr("opacity", 1);
        }
		var selectedOption = d3.select('#selectxdropdown').property("value")
		//console.log("selectedOption:"+selectedOption)
        update_axis(selectedOption)
		enabledisableAnnotation(selectedOption)
        //plot_points("Avg_ Birth Rate (Per 1000) (SUM)");
    }
	
	function enabledisableAnnotation()
	{
	}
    function plot_points(X_Col,selectedGrp)
	{
	    //console.log("Year inside Plot Points:"+select_year)
		//console.log("selectedGrp inside Plot Points:"+selectedGrp)
        //d3.select("#chart").selectAll("circle").data(clear_all).exit().remove()
        let cur_x = 0
        let cur_y = 0
        let max_val = 0
		let min_val = 1000 
		var xlabel = d3.select("svg").append("text").attr("class", "xlabel").attr("text-anchor", "end")
                       .attr("x", 1000)
                       .attr("y", 1.75*margin+svg_dim+5	)
                       .style('fill', 'DarkGreen')
                       .style('font-weight', 'bold')
                       .text("Avg. Birth Rate (Per 1000 People)")
		var yeartag = d3.select("svg").append("text").attr("class", "yeartag")
		var ylabel = d3.select("svg").append("text").attr("class", "y label")
		let select_year_data = data.filter(function(e){return (e.Year==select_year && e["Avg_ Death Rate (Per 1000) (SUM)"] != 0)})
		if (selectedGrp == "BirthRate") {
						select_year_data = data.filter(function(e){return (e.Year==select_year && e["Avg_ Death Rate (Per 1000) (SUM)"] != 0 && !isNaN(e["Avg_ Death Rate (Per 1000) (SUM)"]))})
						// Change the X Axis Label
						xlabel.select("text").remove()
						//xlabel.selectAll("text").remove() // Clear Old Text before replacing it with the new one.
						xlabel.text("Avg. Birth Rate (Per 1000 People)");
						}
		else if (selectedGrp == "HealthSpend") {
						select_year_data = data.filter(function(e){return (e.Year==select_year && e["Avg_ Health Spend / Capita ($) (SUM)"] != 0 && e["Avg_ Death Rate (Per 1000) (SUM)"] != 0)})
						// Change the X Axis Label
						d3.select("svg").selectAll("xlabel").sremove() // Clear Old Text before replacing it with the new one.
						xlabel.text("Avg. Health Spend Per Capita (In US $)");
						}
		else if (selectedGrp == "LifeExp") {
						select_year_data = data.filter(function(e){return (e.Year==select_year && e["Avg_ Life Expectancy (SUM)"] != 0 && e["Avg_ Death Rate (Per 1000) (SUM)"] != 0 && !isNaN(e["Avg_ Life Expectancy (SUM)"]))})
						// Change the X Axis Label
						xlabel.selectAll("text").remove() // Clear Old Text before replacing it with the new one.
						xlabel.text("Avg. Life Expectancy");
						}
		
        //let select_year_data = data.filter(({ Region, Year}) => selected_region.includes(Region) && Year==select_year )
        //let select_year_region_data = data.filter(({ Region, Year }) => selected_region.includes(Region) && Year==select_year)
        for(i=0; i < select_year_data.length; i++){
            let xcol = Number(select_year_data[i][X_Col])
            let death_rate = Number(select_year_data[i]["Avg_ Death Rate (Per 1000) (SUM)"]);
            let country = select_year_data[i]["Country Code (WDICountry_csv)"]
			let country_name = select_year_data[i]["Country Name"]
            let region = select_year_data[i]["Region"]
			
			if (country == "") {console.log("country,xcol:"+country+xcol)}
			
			max_col_val = Number(select_year_data[i][X_Col]);
			min_col_val = Number(select_year_data[i][X_Col]);

            if(min_col_val < min_val && min_col_val!= 0) min_val = min_col_val;
            if(max_col_val > max_val && max_col_val!= 0) max_val = max_col_val;
			if (selectedGrp == "BirthRate") {
			    x = d3.scaleLinear().domain([4,max_val+5]).range([0,width])
			}
			else if (selectedGrp == "LifeExp") {
			    x = d3.scaleLinear().domain([42,max_val+5]).range([0,width]);
			}
			else if (selectedGrp == "HealthSpend") {x = d3.scaleLog().domain([10,max_val+500]).range([0,width])}

            const t = d3.transition()
                .duration(2000).delay(100)
                .ease(d3.easeLinear);

            if(selected_region.indexOf(region)>-1 && xcol != 0)
			{
                d3.select("#" + country).attr("opacity",0.8);
				d3.select("#" + country).style("visibility","visible") 
				d3.select("#" + country ).datum(select_year_data[i])
			}
            else
                //d3.select("#" + country).attr("opacity",0)
				d3.select("#" + country).style("visibility","hidden") // To make sure when mousehover happens nothing is visible.
				// opacity Zero does disappers the circle but mousehover can still happens
				
				
			d3.select("#" + country ).transition(t).attr("transform", "translate(" + x(xcol) + "," + y(death_rate) + ")")
			
            //if (xcol != 0 && selected_region.indexOf(region)>-1) {
            //        d3.select("#" + country ).datum(select_year_data[i])
			//}
        }
		// Re-Plot X Axis again
        d3.select('svg').selectAll('g.xaxis').transition().duration(1000).call(d3.axisBottom(x).tickFormat(d3.format("~d")));
		// Set the Year Label as per the Selection
		yeartag.text(select_year);
    }	
</script>
</body>
</html>