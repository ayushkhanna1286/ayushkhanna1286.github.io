<!DOCTYPE html>
<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
<link href='https://fonts.googleapis.com/css?family=Lato:300,900' rel='stylesheet' type='text/css'>
<style>
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 110px;
        height: 32px;
        padding: 2px;
        font: 14px sans-serif;
        background: coral;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }

    svg {
        background-color: GhostWhite;
        font-family: 'Lato';
    }

    .annotation-group, text.title {
        font-size: .9em;
    }

    text.title {
        font-size: .10em;
    }
	
	/* circle {fill: lightblue; stroke: black;} */
	circle {stroke: black;}
</style>
<body onload='init();'>
<svg width=1800 height=800>
</svg>
<script>
	 let FuelType = []
	 let selected_FuelType = []
async function init() {
     // Read the Data	   
     data = await d3.csv("https://flunky.github.io/cars2017.csv");
	 const type = d3.annotationLabel
	 let svg_dim = 700
	 const annotations = [{
           note: {
                 label: "Longer text to show text wrapping",
                 bgPadding: 5,
                 title: "Annotations..."
           },
           //can use x, y directly instead of data
           x: 1050,
           y: 350,
           className: "show-bg",
           dy: 70,
           dx: 50
     }]

     const makeAnnotations = d3.annotation().editMode(true)
                             .notePadding(15)
                             .type(type)
                             .annotations(annotations)
     var margin=50
     var width=1700
     var height=700
	 clear_all = []
     d3.selectAll("g").data(clear_all).exit().remove()
     //console.log(data[0])
     var AverageCityMPG = [], AverageHighwayMPG = [], EngineCylinders = [], Fuel = [];
 
     data.map(function(d) {
	         AverageCityMPG.push(d.AverageCityMPG);
			 AverageHighwayMPG.push(d.AverageHighwayMPG);
			 EngineCylinders.push(d.EngineCylinders);
			 Fuel.push(Fuel);
     });

	 FuelType = d3.map(data, function(d){return d.Fuel;}).keys()
	 console.log(FuelType)
	 selected_FuelType = [...FuelType]

	 //console.log(EngineCylinders)
     x = d3.scaleLog().domain([10,650]).range([0,width])
     y = d3.scaleLog().domain([10,650]).range([height,0])
     c_col = d3.scaleOrdinal().domain(FuelType).range([ "#440154ff", "#21908dff", "#fde725ff"])
	 console.log(c_col);
     d3.select('svg')
       .append('g')
	   .attr("id", "chart")
       .attr("transform","translate("+ margin + "," + margin + ")")
	 
	 let chart = d3.select("#chart")
	 var div = d3.select("body").append("div")
               .attr("class", "tooltip")
               .style("opacity", 0);

	 chart.selectAll("g")
	   .data(data)
	   .enter()
	   .append('circle')
       .attr('cx', function(d,i) {return x(d.AverageCityMPG)})
	   .attr('cy', function(d,i) {return y(d.AverageHighwayMPG)})
	   .attr('r', function(d,i) {return (10+(+d.EngineCylinders))}) // For Sum add an additional 10 + inside d.EngineCylinders
       .attr("id", function(d,i){return "A"+i}) 
       .style("fill", function(d){ return c_col(d.Fuel)})	   
	   // Add Tooltip to show the Fuel type on mouse over
       .on("mouseover", function(d) {      
                        div.transition()     
                           .duration(200)      
                           .style("opacity", .9);      
                        //div.html(function(){console.log(d.AverageHighwayMPG); return d.Fuel})  
						div.html(function(){return d.Make})  
                           .style("left", (d3.event.pageX) + "px")     
                           .style("top", (d3.event.pageY - 28) + "px");    
                     })                  
                     .on("mouseout", function(d) {       
                              div.transition()        
                                 .duration(500)      
                                 .style("opacity", 0);   
                     })

       chart.selectAll("foreignObject")
                .data(FuelType).enter()
                .append("foreignObject")
                .attr('x', 1440)
                .attr('y',  function(d,i){ return 550-10 + i*20})
                .attr('width', 290)
                .attr('height', 20)
                .append("xhtml:tree")
                .html(function(d, i){
                    let s = "<label style='color:" + c_col(d)
                        + "'><input type='checkbox' checked=true id='" + d
                        + "' onclick=ARegionClicked(this)>" + d + "</label>"
                    return(s);
                })
                .style("fill", function(d){ return c_col(d)})
     // Plot Y Axis
     d3.select('svg').append('g')
       .attr("transform","translate("+ margin + "," + margin + ")")
       .call(d3.axisLeft(y).tickValues([10,100,150,200,250,300,350,450,550,650]).tickFormat(d3.format("~s")))
     
     // Plot X Axis
     d3.select('svg').append('g')
       .attr("transform", "translate(" + margin + ",750)")
       .call(d3.axisBottom(x).tickValues([10,50,100,150,200,250,300,350,450,550,650]).tickFormat(d3.format("~s")))
	   
     // Plot Annotations
     d3.select('svg').append('g')
	   .attr("class", "annotation-group")
       .call(makeAnnotations)
	 
     //	 Plot X and Y Labels
	 d3.select("svg").append("text")
       .attr("class", "x label")
       .attr("text-anchor", "end")
       .attr("x", 1000)
       .attr("y", 1.75*margin+svg_dim)
       .style('fill', 'DarkGreen')
       .style('font-weight', 'bold')
       .text("Average City MPG")

     d3.select("svg").append("text")
       .attr("class", "y label")
       .attr("text-anchor", "end")
       .attr("x", -svg_dim/3)
       .attr("y", 20)
       .attr("dy", ".25em")
       .style('fill', 'DarkGreen')
       .style('font-weight', 'bold')
       .attr("transform", "rotate(-90)")
       .text("Average Highway MPG");
     }
	 
	function ARegionClicked(object){
        let checked = object.checked
        let clicked_FuelType = object.id
        console.log("Checked Value:"+checked);
		console.log("Clicked Value:"+clicked_FuelType);
        if (!checked){
            selected_FuelType.splice(selected_FuelType.indexOf(clicked_FuelType),1);
            if(clicked_FuelType=="Gasoline") d3.select(".Gasoline").attr("opacity", 0)
            if(clicked_FuelType=="Diesel") d3.select(".Diesel").attr("opacity", 0);
            if(clicked_FuelType=="Electricity") d3.select(".Electricity").attr("opacity", 0);
        }
        else{
            selected_FuelType.push(clicked_FuelType);
            if(clicked_FuelType=="Gasoline") d3.select(".Gasoline").attr("opacity", 1)
            if(clicked_FuelType=="Diesel") d3.select(".Diesel").attr("opacity", 1);
            if(clicked_FuelType=="Electricity") d3.select(".Electricity").attr("opacity", 1);
        }

         plot_points();
    }
	
	function plot_points(){

        let cur_x = 0
        let cur_y = 0

        let select_year_data = data
        let select_year_region_data = data
		console.log("Length:"+select_year_data.length)
        for(i=0; i<select_year_data.length; i++){
            let CircleId = "A"+i 
			//console.log("FuelType:"+FuelType)
            let region = select_year_data[i]["Fuel"]

            const t = d3.transition()
                .duration(2000).delay(100)
                .ease(d3.easeLinear);
            console.log(selected_FuelType.indexOf(region))
            if(selected_FuelType.indexOf(region)>-1)
                d3.select("#" + CircleId).attr("opacity",1) // Set the Opacity to Visible
				                         .style("fill", function(d){ return c_col(d.Fuel)})
				
            else
                d3.select("#" + CircleId).attr("opacity",0.25) // Set the Opacity to dim Circle and set color to grey
				                         .transition()
                                         .duration(200)
                                         .style("fill", "lightgrey");
    
            d3.select("#" + CircleId ).datum(select_year_data[i]) 
        }
    }
</script>
</body>
</html>